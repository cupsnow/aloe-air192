<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <title>Air192 management</title>
</head>

<body>
  <!-- global script -->
  <script>
    function show_reason(htag, resp) {
      var cout = function (msg) {
        if (htag) htag.innerHTML = `<pre>${msg}</pre>`;
        else console.log(msg);
      };

      if ((typeof resp) == "string") {
        cout(`<pre>${resp}</pre>`);
      } else if (resp instanceof XMLHttpRequest) {
        if (resp.response.reason) {
          cout(`<pre>${resp.response.reason}</pre>`);
        } else if ("responseText" in resp) {
          cout(`<pre>${resp.status} ${resp.responseText}</pre>`);
        }
      }
    }

    function send_json_req1(method, uri, jobj, on_resp_done) {
      var xhr = new XMLHttpRequest();
      xhr.open(method, uri, !!on_resp_done);
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.responseType = "json";
      if (on_resp_done) {
        xhr.onreadystatechange = function () {
          if (xhr.readyState == XMLHttpRequest.DONE) {
            // if ((xhr.status === 0 || (xhr.status >= 200 && xhr.status < 400))
            //   && xhr.responseType == "json") {
            //   console.log(`response: ${JSON.stringify(xhr.response)}`)
            // }
            on_resp_done(xhr);
          }
        };
      }
      xhr.send(JSON.stringify(jobj));
      return xhr;
    }

    function cboxInvalidate(cbox, list) {
      while (cbox.options.length > 0) {
        cbox.options.remove(cbox.options.length - 1);
      }
      list.forEach((iter, idx) => {
        var opt = document.createElement('option');
        opt.value = iter[0];
        opt.text = iter.length > 1 ? iter[1] : iter[0];
        cbox.options.add(opt);
      });
    }
  </script>

  <p id="sysinfo_text"></p>
  <script>
    sysinfoList = {};

    function sysinfo_update() {
      var sysinfo_text = document.getElementById("sysinfo_text");
      var req_args = null;

      req_args = { command: "get_config" };
      var xhr = send_json_req1("POST", "/cgi-bin/admin_acccfg.cgi",
        req_args,
        function (xhr) {
          if ((xhr.status === 0 || (xhr.status >= 200 && xhr.status < 400))
            && xhr.responseType == "json") {
            if (xhr.response.result === 0) {
              delete sysinfoList;
              sysinfoList = {};
              ["version", "hw_version", "homekit_paired"].forEach((iter, idx) => {
                if (iter in xhr.response) sysinfoList[iter] = xhr.response[iter];
              });
              if (Object.keys(sysinfoList).length > 0) {
                sysinfo_text.innerHTML = "<h2>System Info<h2/>"
                if ("version" in sysinfoList) {
                  sysinfo_text.innerHTML += `Version: ${sysinfoList.version}<br/>`;
                }
                if ("hw_version" in sysinfoList) {
                  sysinfo_text.innerHTML += `Hardware version: ${sysinfoList.hw_version}<br/>`;
                }
                if ("homekit_paired" in sysinfoList && sysinfoList.homekit_paired) {
                  sysinfo_text.innerHTML += `Homekit paired<br/>`;
                }
              }
              if (("accessory_name" in xhr.response)) {
                sysinfoList["accessory_name"] = xhr.response.accessory_name;
                var accname_text = document.getElementById("acccfg_accname_text");
                if (accname_text) {
                  accname_text.value = xhr.response.accessory_name;
                }
              }

            } else {
              show_reason(null, xhr);
            }
          } else {
            show_reason(null, xhr);
          }
        });
    }
    sysinfo_update();
  </script>

  <h2>Firmware Update</h2>
  <!-- <form name="fwupd_form" id="fwupd_form" action="/cgi-bin/admin_fwupd.cgi"> -->
  <p>
    <label>OTA File URI:<br />
      <input type="text" name="ota_file_uri" id="ota_file_uri" value="http://192.168.18.6:3000/media/ota-host.tar.gz" />
    </label> <br />
    <label>Enforce even completed
      <input type="checkbox" name="ota_enforce" id="ota_enforce" />
    </label>
    <label>dryrun
      <input type="checkbox" name="ota_dryrun" id="ota_dryrun" />
    </label>
    <label>Reboot after complete
      <input type="checkbox" name="ota_complete_reboot" id="ota_complete_reboot" checked />
    </label>
  </p>
  <p>
    <label>Comment:<br />
      <input type="text" name="comment" value="comment" />
    </label><br />
  </p>
  <!-- <input type="submit" value="Submit" />
  </form> -->
  <br />
  <button type="button" id="fwupd_set_button">Start</button>
  <button type="button" id="fwupd_get_button">Get</button>
  <em id="fwupd_result_text"></em>
  <br />

  <script>
    fwupd_req_start_ts = 0;
    function fwupd_req(evt, applet, due) {
      var ota_file_text = document.getElementById("ota_file_uri");
      var ota_enforce_ck = document.getElementById("ota_enforce");
      var ota_dryrun_ck = document.getElementById("ota_dryrun");
      var ota_complete_reboot_ck = document.getElementById("ota_complete_reboot");
      var result_text = document.getElementById("fwupd_result_text");
      var req_args = {};
      complete_reboot_checked = ota_complete_reboot_ck.checked;

      if (applet === "get" || applet === "mon") {
        req_args.command = "get_status";
      } else {
        fwupd_req_start_ts = Date.now();
        req_args.command = "set_fwupd";
        req_args.ota_file_uri = ota_file_text.value;
        shiftKey = null;
        try {
          if (evt.shiftKey) shiftKey = true;
        } catch (err) { }
        if (shiftKey || ota_enforce_ck.checked) req_args.ota_enforce = true;
        if (ota_dryrun_ck.checked) req_args.ota_dryrun = true;
        if (complete_reboot_checked) req_args.ota_complete_reboot = true;
      }
      var xhr = send_json_req1("POST", "/cgi-bin/admin_fwupd2.cgi",
        req_args,
        function (xhr) {
          if ((xhr.status === 0 || (xhr.status >= 200 && xhr.status < 400))
            && xhr.responseType == "json") {
            now = Date.now();
            if (xhr.response.result === 0) {
              result_text.innerHTML = ``;
            } else if (xhr.response.result > 0 && xhr.response.result < 100) {
              if (due != 0 && (applet === "set" || applet === "mon")) {
                result_text.innerHTML = `<pre>Processing (${(now - fwupd_req_start_ts) / 1000})</pre>`;
                fwupd_req(null, "mon", due);
              } else {
                result_text.innerHTML = `<pre>Processing</pre>`;
              }
            } else if (xhr.response.result === 100) {
              msg = "Completed"
              if ((applet === "mon")) {
                msg += `(cost ${(now - fwupd_req_start_ts) / 1000} seconds)`
              }
              if (complete_reboot_checked) {
                result_text.innerHTML = `<pre>${msg}, rebooting</pre>`;
              } else {
                result_text.innerHTML = `<pre>${msg}</pre>`;
              }
            } else if (xhr.response.reason) {
              result_text.innerHTML = `<pre>${xhr.response.reason}</pre>`;
            } else {
              result_text.innerHTML = `<pre>Failed</pre>`;
            }
          } else if (xhr.responseType == "json") {
            if (xhr.response.reason) {
              result_text.innerHTML = `<pre>${xhr.response.reason}</pre>`;
            } else {
              result_text.innerHTML = `<pre>Failed</pre>`;
            }
          } else {
            show_reason(null, xhr);
          }
        });
    }

    document.getElementById("fwupd_set_button").onclick = function (evt) {
      fwupd_req(evt, "set", Date.now() + 60 * 1000);
    }

    document.getElementById("fwupd_get_button").onclick = function (evt) {
      fwupd_req(evt, "get");
    }

  </script>

  <hr />
  <h2>Speaker Latency</h2>
  <p>
    This section setup the latency between audio signal output from hardware terminal and audable from speaker<br />
  </p>
  <p>
    <label>Set latency in milliseconds:<br />
      <input type="number" name="spkcal_latency_text" id="spkcal_latency_text" />
    </label>
    <button type="button" id="spkcal_latency_set_button">Set</button>
    <button type="button" id="spkcal_latency_get_button">Get</button>
    <em id="spkcal_latency_reason_text"></em>
    <br />
    <script>
      function spkcal_req(applet) {
        var latency_text = document.getElementById("spkcal_latency_text");
        var reason_text = document.getElementById("spkcal_latency_reason_text");
        var req_args = {};
        if (applet === "get") {
          req_args.command = "get_spkcal";
        } else if (applet === "auto") {
          req_args.command = "set_spkcal";
          req_args.value = "auto";
        } else {
          req_args.command = "set_spkcal";
          if (latency_text.value !== undefined &&
            Number.isNaN(Number.parseInt(latency_text.value))) {
            throw `Not integer`;
          }
          req_args.value = Number.parseInt(latency_text.value);
          if (applet === "apply") req_args.apply = true;
        }
        var xhr = send_json_req1("POST", "/cgi-bin/admin_spkcal.cgi",
          req_args, function (xhr) {
            if ((xhr.status === 0 || (xhr.status >= 200 && xhr.status < 400))
              && xhr.responseType == "json") {
              if (xhr.response.result === 0) {
                latency_text.value = xhr.response.value;
                if (xhr.response.reason) {
                  show_reason(reason_text, xhr);
                } else if (xhr.response.raw) {
                  show_reason(reason_text, `raw: ${xhr.response.raw}`);
                }
              } else {
                show_reason(reason_text, xhr);
              }
            } else {
              show_reason(reason_text, xhr);
            }
          });
      };

      document.getElementById("spkcal_latency_set_button").onclick = function (evt) {
        shiftKey = null;
        try {
          if (evt.shiftKey) shiftKey = true;
        } catch (err) { }
        spkcal_req(shiftKey ? "apply" : null);
      }

      document.getElementById("spkcal_latency_get_button").onclick = function () {
        spkcal_req("get");
      }
    </script>
  </p>
  <p>
    The auto calibration process will take about 30 seconds, take device closer to speaker before start.<br />
    <button type="button" id="spkcal_auto_button">Start Auto Calibration</button>
    <em id="spkcal_auto_reason_text"></em>

    <script type="application/javascript">
      document.getElementById("spkcal_auto_button").onclick = function () {
        spkcal_req("auto");
      }
    </script>
  </p>

  <hr />
  <h2>WIFI Configuration</h2>
  <p>
    Select SSID in the list or manual input
  </p>
  <p>
    <label>Security type<br />
      <select size="5" id="wificfg_security_cbox" style="max-width: 95%;">
      </select>
    </label><br />
    <label for="wificfg_ssid_text">SSID (
      <label>The SSID is hidden
        <input type="checkbox" name="wificfg_hidden_ckbox" id="wificfg_hidden_ckbox" />
      </label> ) <br />
      <input type="text" name="wificfg_ssid_text" id="wificfg_ssid_text" />
    </label> <br />
    <label>Password<br />
      <input type="password" name="wificfg_password_text" id="wificfg_password_text" />
    </label><br />

    <label>IP Configuration type<br />
      <select size="3" id="wificfg_dhcp_cbox" style="max-width: 95%;">
      </select>
    </label><br />
    <label>IP<br />
      <input type="text" name="wificfg_ip_text" id="wificfg_ip_text" />
    </label>
    <br />
    <label>Netmask<br />
      <input type="text" name="wificfg_netmask_text" id="wificfg_netmask_text" value="255.255.255.0" />
    </label>
    <br />
    <label>Router IP<br />
      <input type="text" name="wificfg_router_text" id="wificfg_router_text" />
    </label>
    <br />
    <label>DNS IP<br />
      <input type="text" name="wificfg_dns_text" id="wificfg_dns_text" value="1.1.1.1" />
    </label>
    <br />
    <button type="button" id="wificfg_get_button">Get</button>
    <button type="button" id="wificfg_set_button">Set</button>
    <button type="button" id="wificfg_reboot_button">Reboot to apply</button>
    <em id="wificfg_reason_text"></em>
    <br />

    <script>
      cboxInvalidate(document.getElementById("wificfg_security_cbox"), [
        ["Open"], ["WPA-TKIP"], ["WPA-CCMP"], ["WPA2-CCMP"], ["WPA3-SAE"]]);

      cboxInvalidate(document.getElementById("wificfg_dhcp_cbox"), [
        ["dhcp", "DHCP"], ["zcip", "DHCP off"], ["manual", "Static IP"]]);

      document.getElementById("wificfg_set_button").onclick = function () {
        var seclist_cbox = document.getElementById("wificfg_security_cbox");
        var ssid_text = document.getElementById("wificfg_ssid_text");
        var password_text = document.getElementById("wificfg_password_text");
        var hidden_ssid_ck = document.getElementById("wificfg_hidden_ckbox");
        var dhcplist_cbox = document.getElementById("wificfg_dhcp_cbox");
        var ip_text = document.getElementById("wificfg_ip_text");
        var msk_text = document.getElementById("wificfg_netmask_text");
        var gw_text = document.getElementById("wificfg_router_text");
        var dns_text = document.getElementById("wificfg_dns_text");
        var reason_text = document.getElementById("wificfg_reason_text");
        var req_args = null;
        try {
          req_args = {
            command: "set_config",
            ssid: ssid_text.value,
            password: password_text.value,
            hidden_ssid: hidden_ssid_ck.checked,
            security_proto: seclist_cbox.options[seclist_cbox.selectedIndex].value,
          };
        } catch (err) {
          show_reason(reason_text, "Invalid input");
          return;
        }

        if (dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "dhcp"
          || dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "auto"
          || dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "zcip") {
          req_args.ip = dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value;
        } else if (ip_text.value === "" || msk_text.value === "" ||
          gw_text.value === "" || dns_text.value === "") {
          show_reason(reason_text, "Invalid input");
          return;
        } else {
          req_args.ip = ip_text.value;
          req_args.netmask = msk_text.value;
          req_args.router = gw_text.value;
          req_args.dns = dns_text.value;
        }

        if (!confirm("Server wifi settings will be overwrite!!")) {
          show_reason(reason_text, "Cancelled");
          return;
        }

        var xhr = send_json_req1("POST", "/cgi-bin/admin_wificfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              if (xhr.response.result === 0) {
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      }

      document.getElementById("wificfg_get_button").onclick = function () {
        var seclist_cbox = document.getElementById("wificfg_security_cbox");
        var ssid_text = document.getElementById("wificfg_ssid_text");
        var password_text = document.getElementById("wificfg_password_text");
        var hidden_ssid_ck = document.getElementById("wificfg_hidden_ckbox");
        var dhcplist_cbox = document.getElementById("wificfg_dhcp_cbox");
        var ip_text = document.getElementById("wificfg_ip_text");
        var msk_text = document.getElementById("wificfg_netmask_text");
        var gw_text = document.getElementById("wificfg_router_text");
        var dns_text = document.getElementById("wificfg_dns_text");
        var reason_text = document.getElementById("wificfg_reason_text");
        var req_args = {
          command: "get_config",
        };

        var xhr = send_json_req1("POST", "/cgi-bin/admin_wificfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                if (!xhr.response.ssid) {
                  show_reason(reason_text, "No config");
                  return;
                }
                ssid_text.value = xhr.response.ssid;
                password_text.value = xhr.response.password ? xhr.response.password : "";
                hidden_ssid_ck.checked = !!xhr.response.hidden_ssid;
                for (i = 0; i < seclist_cbox.options.length; i++) {
                  if (seclist_cbox.options[i].value === xhr.response.security_proto) {
                    seclist_cbox.selectedIndex = i;
                    break;
                  }
                }
                if (xhr.response.ip === "dhcp" || xhr.response.ip === "zcip"
                  || xhr.response.ip === "auto") {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === xhr.response.ip) {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  // auto -> dhcp
                  if (i >= dhcplist_cbox.options.length && xhr.response.ip === "auto") {
                    for (i = 0; i < dhcplist_cbox.options.length; i++) {
                      if (dhcplist_cbox.options[i].value === "dhcp") {
                        dhcplist_cbox.selectedIndex = i;
                        dhcplist_cbox.dispatchEvent(new Event("change"));
                        break;
                      }
                    }
                  }
                } else if (xhr.response.ip) {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === "manual") {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  ip_text.value = xhr.response.ip;
                  msk_text.value = xhr.response.netmask;
                  gw_text.value = xhr.response.router;
                  dns_text.value = xhr.response.dns;
                } else {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === "dhcp") {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  if (i >= dhcplist_cbox.options.length) {
                    dhcplist_cbox.selectedIndex = -1;
                  }
                }
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      }

      document.getElementById("wificfg_reboot_button").onclick = function () {
        var reason_text = document.getElementById("wificfg_reason_text");
        var xhr = send_json_req1("POST", "/cgi-bin/admin_wificfg.cgi",
          {
            command: "reboot"
          }, xhr => {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json" && xhr.response.result == 0) {
              show_reason(reason_text, "Rebooting");
            } else {
              show_reason(reason_text, `Failed`);
            }
          });
      };

      document.getElementById("wificfg_dhcp_cbox").onchange = function (evt) {
        var ip_text = document.getElementById("wificfg_ip_text");
        var msk_text = document.getElementById("wificfg_netmask_text");
        var gw_text = document.getElementById("wificfg_router_text");
        var dns_text = document.getElementById("wificfg_dns_text");
        var cbox = evt.target;
        if (cbox.selectedIndex < 0) return;
        var opt = cbox.options[cbox.selectedIndex];
        if (!opt) return;
        console.log(`sel: ${opt.value}`);

        [ip_text, msk_text, gw_text, dns_text].forEach(
          iter => iter.disabled = (opt.value === "dhcp" || opt.value === "zcip"));
      };

    </script>

  </p>

  <p>
    <button type="button" id="wificfg_aplist_refresh_button">
      Refresh Access Point List
    </button> <br />
    <label> Show more details
      <input type="checkbox" name="wificfg_aplist_detail" , id="wificfg_aplist_detail" />
    </label> <br />
    <em id="wificfg_aplist_reason_text"></em>
    <br />
    <select size="5" id="wificfg_aplist_cbox" style="max-width: 95%;">
    </select>
    <script>
      var apList = [];
      var ssidList = [];

      function aplistInvalidate(list) {
        var aplist_cbox = document.getElementById("wificfg_aplist_cbox");
        var detail_ck = document.getElementById("wificfg_aplist_detail");
        while (aplist_cbox.options.length > 0) {
          aplist_cbox.options.remove(aplist_cbox.options.length - 1);
        }

        if (list !== undefined) apList = list;
        ssidList.length = 0;

        apList.sort(function (a, b) { return b.rssi - a.rssi });

        apList.forEach((iter, idx) => {
          if (!("ssid" in iter) || !("bssid" in iter)
            || (iter.ssid.length <= 0)) {
            return;
          }

          var ssidIter = ssidList.find(a => a.ssid === iter.ssid);
          if (!ssidIter) {
            ssidIter = {
              ssid: iter.ssid, bssid: iter.bssid, rssi: iter.rssi,
              freq: iter.freq, flags: iter.flags.match(/\[[^\[]*\]/g)
            };
            ssidList.push(ssidIter);
          } else {
            ssidIter.rssi = Math.min(ssidIter.rssi, iter.rssi);
            iter.flags.match(/\[[^\[]*\]/g).forEach((iterFlag, idx) => {
              if (!ssidIter.flags.find(ssidIterFlag => ssidIterFlag === iterFlag)) {
                ssidIter.flags.push(iterFlag);
              }
            });
          }

          if (detail_ck && detail_ck.checked) {
            var opt = document.createElement('option');
            opt.text = `${iter.ssid}`
              + ` (frequency: ${iter.freq}`
              + `, bssid: ${iter.bssid}`
              + `, flags: ${"flags" in iter ? iter.flags : "[]"}`
              + `, rssi: ${iter.rssi})`;
            opt.value = iter.bssid;
            aplist_cbox.options.add(opt);
            return;
          }
        });

        if (!detail_ck || !detail_ck.checked) {
          ssidList.forEach((iter, idx) => {
            opt = document.createElement('option');
            opt.text = `${iter.ssid}`
            if (detail_ck) {
              opt.text += ` (flags: ${iter.flags.join("")})`;
            }
            opt.value = iter.bssid;
            aplist_cbox.options.add(opt);
          });
        }
        console.log(apList);
      }

      document.getElementById("wificfg_aplist_refresh_button").onclick = function () {
        var aplist_cbox = document.getElementById("wificfg_aplist_cbox");
        var reason_text = document.getElementById("wificfg_aplist_reason_text");
        var xhr = send_json_req1("POST", "/cgi-bin/admin_wificfg.cgi",
          {
            command: "get_aplist"
          },
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if (respType != "json" ||
              ((respCode !== 0) && (respCode < 200 || respCode >= 400))) {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
              return;
            }
            console.log(`response: ${JSON.stringify(xhr.response)}`)
            if (xhr.response.result != 0) {
              show_reason(reason_text, xhr);
              return;
            }
            if (!Array.isArray(xhr.response.aplist)) {
              show_reason(reason_text, `Invalid response: ${xhr.response.aplist}`);
              return;
            }
            aplistInvalidate(xhr.response.aplist);
          });
      }

      document.getElementById("wificfg_aplist_cbox").onchange = function (evt) {
        var ssid_text = document.getElementById("wificfg_ssid_text");
        var cbox = evt.target;
        var opt = cbox.options[cbox.selectedIndex];
        if (!opt) return;
        console.log(`sel: ${opt.value}`);
        var found = apList.find(a => a.bssid === opt.value);
        ssid_text.value = found.ssid;
      }
    </script>
  </p>

  <hr />
  <h2>Ethernet Configuration</h2>
  <p>
    <label>IP Configuration type<br />
      <select size="3" id="ethcfg_dhcp_cbox" style="max-width: 95%;">
      </select>
    </label><br />
    <label>IP<br />
      <input type="text" name="ethcfg_ip_text" id="ethcfg_ip_text" />
    </label>
    <br />
    <label>Netmask<br />
      <input type="text" name="ethcfg_netmask_text" id="ethcfg_netmask_text" value="255.255.255.0" />
    </label>
    <br />
    <label>Router IP<br />
      <input type="text" name="ethcfg_router_text" id="ethcfg_router_text" />
    </label>
    <br />
    <label>DNS IP<br />
      <input type="text" name="ethcfg_dns_text" id="ethcfg_dns_text" value="1.1.1.1" />
    </label>
    <br />
    <button type="button" id="ethcfg_get_button">Get</button>
    <button type="button" id="ethcfg_set_button">Set</button>
    <button type="button" id="ethcfg_reboot_button">Reboot to apply</button>
    <em id="ethcfg_reason_text"></em>
    <br />
    <script>
      cboxInvalidate(document.getElementById("ethcfg_dhcp_cbox"), [
        ["dhcp", "DHCP"], ["zcip", "DHCP off"], ["manual", "Static IP"]]);

      document.getElementById("ethcfg_set_button").onclick = function () {
        var dhcplist_cbox = document.getElementById("ethcfg_dhcp_cbox");
        var ip_text = document.getElementById("ethcfg_ip_text");
        var msk_text = document.getElementById("ethcfg_netmask_text");
        var gw_text = document.getElementById("ethcfg_router_text");
        var dns_text = document.getElementById("ethcfg_dns_text");
        var reason_text = document.getElementById("ethcfg_reason_text");
        var req_args = null;

        req_args = { command: "set_config" };
        if (dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "dhcp"
          || dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "auto"
          || dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value == "zcip") {
          req_args.ip = dhcplist_cbox.options[dhcplist_cbox.selectedIndex].value;
        } else if (ip_text.value === "" || msk_text.value === "" ||
          gw_text.value === "" || dns_text.value === "") {
          show_reason(reason_text, "Invalid input");
          return;
        } else {
          req_args.ip = ip_text.value;
          req_args.netmask = msk_text.value;
          req_args.router = gw_text.value;
          req_args.dns = dns_text.value;
        }

        if (!confirm("Server ethernet settings will be overwrite!!")) {
          show_reason(reason_text, "Cancelled");
          return;
        }

        var xhr = send_json_req1("POST", "/cgi-bin/admin_ethcfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      };

      document.getElementById("ethcfg_get_button").onclick = function () {
        var dhcplist_cbox = document.getElementById("ethcfg_dhcp_cbox");
        var ip_text = document.getElementById("ethcfg_ip_text");
        var msk_text = document.getElementById("ethcfg_netmask_text");
        var gw_text = document.getElementById("ethcfg_router_text");
        var dns_text = document.getElementById("ethcfg_dns_text");
        var reason_text = document.getElementById("ethcfg_reason_text");
        var req_args = {
          command: "get_config",
        };

        var xhr = send_json_req1("POST", "/cgi-bin/admin_ethcfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                if (xhr.response.ip === "dhcp" || xhr.response.ip === "zcip"
                  || xhr.response.ip === "auto") {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === xhr.response.ip) {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  // auto -> dhcp
                  if (i >= dhcplist_cbox.options.length && xhr.response.ip === "auto") {
                    for (i = 0; i < dhcplist_cbox.options.length; i++) {
                      if (dhcplist_cbox.options[i].value === "dhcp") {
                        dhcplist_cbox.selectedIndex = i;
                        dhcplist_cbox.dispatchEvent(new Event("change"));
                        break;
                      }
                    }
                  }
                } else if (xhr.response.ip) {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === "manual") {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  ip_text.value = xhr.response.ip;
                  msk_text.value = xhr.response.netmask;
                  gw_text.value = xhr.response.router;
                  dns_text.value = xhr.response.dns;
                } else {
                  for (i = 0; i < dhcplist_cbox.options.length; i++) {
                    if (dhcplist_cbox.options[i].value === "dhcp") {
                      dhcplist_cbox.selectedIndex = i;
                      dhcplist_cbox.dispatchEvent(new Event("change"));
                      break;
                    }
                  }
                  if (i >= dhcplist_cbox.options.length) {
                    dhcplist_cbox.selectedIndex = -1;
                  }
                }
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      };

      document.getElementById("ethcfg_reboot_button").onclick = function () {
        var reason_text = document.getElementById("ethcfg_reason_text");

        if (!confirm("Server will lost connection!!")) {
          show_reason(reason_text, "Cancelled");
          return;
        }

        var xhr = send_json_req1("POST", "/cgi-bin/admin_ethcfg.cgi",
          {
            command: "reboot"
          }, xhr => {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json" && xhr.response.result == 0) {
              show_reason(reason_text, "Rebooting");
            } else {
              show_reason(reason_text, `Failed`);
            }
          });
      };

      document.getElementById("ethcfg_dhcp_cbox").onchange = function (evt) {
        var ip_text = document.getElementById("ethcfg_ip_text");
        var msk_text = document.getElementById("ethcfg_netmask_text");
        var gw_text = document.getElementById("ethcfg_router_text");
        var dns_text = document.getElementById("ethcfg_dns_text");
        var cbox = evt.target;
        if (cbox.selectedIndex < 0) return;
        var opt = cbox.options[cbox.selectedIndex];
        if (!opt) return;
        console.log(`sel: ${opt.value}`);

        [ip_text, msk_text, gw_text, dns_text].forEach(
          iter => iter.disabled = (opt.value === "dhcp" || opt.value === "zcip"));
      };

    </script>
  </p>

  <hr />
  <h2>Accessory Name</h2>
  <p>
    <label>Accessory name<br />
      <input type="text" name="acccfg_accname_text" id="acccfg_accname_text" />
    </label> <br />
    <button type="button" id="acccfg_get_button">Get</button>
    <button type="button" id="acccfg_set_button">Set</button>
    <em id="acccfg_reason_text"></em>
    <br />
    <script>
      document.getElementById("acccfg_set_button").onclick = function (evt) {
        var accname_text = document.getElementById("acccfg_accname_text");
        var reason_text = document.getElementById("acccfg_reason_text");
        var req_args = null;

        req_args = { command: "set_config", apply: true };
        if (accname_text.value === "") {
          show_reason(reason_text, "Invalid input");
          return;
        }
        req_args.accessory_name = accname_text.value;
        try {
          if (evt.shiftKey) req_args.enforce = true;
        } catch (err) { }

        var xhr = send_json_req1("POST", "/cgi-bin/admin_acccfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });

      };

      document.getElementById("acccfg_get_button").onclick = function () {
        var accname_text = document.getElementById("acccfg_accname_text");
        var reason_text = document.getElementById("acccfg_reason_text");
        var req_args = null;

        req_args = { command: "get_config" };
        var xhr = send_json_req1("POST", "/cgi-bin/admin_acccfg.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                if (!xhr.response.accessory_name) {
                  show_reason(reason_text, "No config");
                  return;
                }
                accname_text.value = xhr.response.accessory_name;
                if (xhr.response.homekit_paired) {
                  show_reason(reason_text, "Homekit paired");
                }
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      };

    </script>
  </p>

  <hr />
  <h2>LED override off</h2>
  <p>
    <label>LED override off
      <input type="checkbox" name="ledban_ckbox" id="ledban_ckbox" />
    </label><br />
    <button type="button" id="ledban_get_button">Get</button>
    <button type="button" id="ledban_set_button">Set</button>
    <em id="ledban_reason_text"></em>
    <br />
    <script>
      document.getElementById("ledban_set_button").onclick = function (evt) {
        var ledban_ckbox = document.getElementById("ledban_ckbox");
        var reason_text = document.getElementById("ledban_reason_text");
        var req_args = null;

        req_args = { command: "set_config" };
        req_args.led_override_off = ledban_ckbox.checked;

        var xhr = send_json_req1("POST", "/cgi-bin/admin_ledban.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                show_reason(reason_text, "Ok");
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, resp: ${xhr}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      };

      document.getElementById("ledban_get_button").onclick = function () {
        var ledban_ckbox = document.getElementById("ledban_ckbox");
        var reason_text = document.getElementById("ledban_reason_text");
        var req_args = null;

        req_args = { command: "get_config" };
        var xhr = send_json_req1("POST", "/cgi-bin/admin_ledban.cgi",
          req_args,
          function (xhr) {
            var respCode = xhr.status;
            var respType = xhr.responseType;
            if ((respCode === 0 || (respCode >= 200 && respCode < 400))
              && respType == "json") {
              console.log(`response: ${JSON.stringify(xhr.response)}`)
              if (xhr.response.result === 0) {
                if (!("led_override_off" in xhr.response)) {
                  show_reason(reason_text, "No config");
                  return;
                }
                ledban_ckbox.checked = xhr.response.led_override_off
              } else if (xhr.response.reason) {
                show_reason(reason_text, xhr);
              } else {
                show_reason(reason_text, `Failed`);
              }
            } else {
              console.log(`status: ${respCode}, type: ${respType}, resp: ${xhr.responseText}`);
              show_reason(reason_text, xhr.responseText);
            }
          });
      };

    </script>
  </p>

</body>

</html>